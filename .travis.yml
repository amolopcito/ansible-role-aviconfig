---
dist: trusty
sudo: required
language: python

before_install:
  - sudo apt-get update

env:
  global:
    - ROLE_NAME: aviconfig
  matrix:
    - MOLECULE_DISTRO: docker.io/pycontribs/centos:7
      MOLECULE_SERVICE_MANAGER: systemd
      MOLECULE_COMMAND: /usr/sbin/init
    - MOLECULE_DISTRO: ubuntu:16.04
      MOLECULE_SERVICE_MANAGER: systemd
      MOLECULE_COMMAND: /usr/sbin/init
    - MOLECULE_DISTRO: ubuntu:18.04
      MOLECULE_SERVICE_MANAGER: systemd
      MOLECULE_COMMAND: /usr/sbin/init
services:
  - docker

#before_install:
#  - sudo apt-get update
#  # Pull container
#  - 'sudo docker pull ${distribution}:${version}'
#  # Customize container
#  - 'sudo docker build --rm=true --file=tests/Dockerfile.${distribution}-${version} --tag=${distribution}-${version}:ansible tests'

#script:
#  - container_id=$(mktemp)
#
#  # Run container in detached state
#  - 'sudo docker run --privileged --detach --volume="${PWD}":/etc/ansible/roles/role_under_test:ro ${run_opts} ${distribution}-${version}:ansible "${init}" > "${container_id}"'
#
#  # install avinetworks.avisdk dependency
#  - 'sudo docker exec --tty "$(cat ${container_id})" env TERM=xterm ansible-galaxy install -c avinetworks.avisdk'
#
#  # Ansible syntax check.
#  - 'sudo docker exec --tty "$(cat ${container_id})" env TERM=xterm ansible-playbook /etc/ansible/roles/role_under_test/tests/test.yml --syntax-check'
#
#  # Test role.
#  - 'sudo docker exec --tty "$(cat ${container_id})" env TERM=xterm ansible-playbook /etc/ansible/roles/role_under_test/tests/test.yml'
#
#  # Test role idempotence.
#  - >
#    sudo docker exec "$(cat ${container_id})" ansible-playbook /etc/ansible/roles/role_under_test/tests/test.yml
#    | grep -q 'changed=0.*failed=0'
#    && (echo 'Idempotence test: pass' && exit 0)
#    || (echo 'Idempotence test: fail' && exit 1)
#  # Clean up
#  - 'sudo docker stop "$(cat ${container_id})"'

install:
  - pip install molecule docker pluggy==0.13.1

before_script:
  - cd ../
  - mv ansible-role-$ROLE_NAME avinetworks.$ROLE_NAME
  - cd avinetworks.$ROLE_NAME

script:
  - molecule test

notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
  email:
    recipients:
#      - grastogi@avinetworks.com
#      - chaitanya.deshpande@avinetworks.com
#      - shrikant.patil@avinetworks.com
      - rohan.suryawanshi@avinetworks.com
    on_failure: always
